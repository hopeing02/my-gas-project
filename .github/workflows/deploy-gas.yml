name: Deploy to Google Apps Script

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install clasp
        run: npm install -g @google/clasp
      
      - name: Check if secret exists
        run: |
          if [ -z "${{ secrets.CLASPRC_JSON }}" ]; then
            echo "❌ ERROR: CLASPRC_JSON secret is empty or not set!"
            echo "Please check GitHub Settings > Secrets and variables > Actions"
            exit 1
          else
            echo "✅ CLASPRC_JSON secret exists"
            echo "Secret length: $(echo '${{ secrets.CLASPRC_JSON }}' | wc -c)"
          fi
      
      - name: Create credentials file
        run: |
          mkdir -p ~/.config/@google
          echo '${{ secrets.CLASPRC_JSON }}' > ~/.clasprc.json
          echo "✅ Credentials file created at ~/.clasprc.json"
          ls -la ~/
          if [ -f ~/.clasprc.json ]; then
            echo "✅ File exists"
            echo "File size: $(wc -c < ~/.clasprc.json) bytes"
          else
            echo "❌ File not created!"
            exit 1
          fi
      
      - name: Verify project files
        run: |
          echo "=== Project structure ==="
          ls -la
          echo ""
          echo "=== .clasp.json content ==="
          if [ -f .clasp.json ]; then
            cat .clasp.json
          else
            echo "❌ .clasp.json not found!"
            exit 1
          fi
          echo ""
          echo "=== src/ directory ==="
          if [ -d src ]; then
            ls -la src/
          else
            echo "❌ src/ directory not found!"
            exit 1
          fi
      
      - name: Push to Apps Script
        run: clasp push --force