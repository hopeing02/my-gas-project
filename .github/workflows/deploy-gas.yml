name: Deploy to Google Apps Script

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
      
      - name: Install clasp
        run: npm install -g @google/clasp@latest
      
      - name: Create and normalize credentials
        run: |
          echo '${{ secrets.CLASPRC_JSON }}' > ~/.clasprc.json.raw
          
          # ìƒˆ í˜•ì‹ì„ êµ¬ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
          node << 'SCRIPT'
          const fs = require('fs');
          const data = JSON.parse(fs.readFileSync(process.env.HOME + '/.clasprc.json.raw', 'utf8'));
          
          let result;
          if (data.tokens && data.tokens.default) {
            console.log('ğŸ”„ Converting new format to old format...');
            const token = data.tokens.default;
            result = {
              token: {
                access_token: token.access_token,
                refresh_token: token.refresh_token,
                scope: "https://www.googleapis.com/auth/script.projects https://www.googleapis.com/auth/script.webapp.deploy https://www.googleapis.com/auth/logging.read https://www.googleapis.com/auth/service.management https://www.googleapis.com/auth/drive.metadata.readonly https://www.googleapis.com/auth/drive.file",
                token_type: token.token_type || "Bearer",
                expiry_date: token.expiry_date
              },
              oauth2ClientSettings: {
                clientId: token.client_id,
                clientSecret: token.client_secret,
                redirectUri: "http://localhost"
              },
              isLocalCreds: false
            };
            console.log('âœ… Converted successfully');
          } else if (data.token) {
            console.log('âœ… Already in old format');
            result = data;
          } else {
            console.error('âŒ Unknown format');
            process.exit(1);
          }
          
          fs.writeFileSync(process.env.HOME + '/.clasprc.json', JSON.stringify(result, null, 2));
          console.log('âœ… Credentials file ready');
          SCRIPT
      
      - name: Verify project files
        run: |
          echo "=== .clasp.json ==="
          cat .clasp.json
          echo ""
          echo "=== src/ files ==="
          ls -la src/
          echo ""
          echo "=== Checking for test functions ==="
          if grep -q "testAll" src/Code.gs; then
            echo "âœ… testAll() function found"
          else
            echo "âš ï¸  No testAll() function found"
          fi
      
      - name: Push to Apps Script
        id: push
        run: |
          echo "ğŸ“¤ Pushing code to Apps Script..."
          clasp push --force
          echo "âœ… Code pushed successfully"
      
      - name: Run Tests
        id: test
        continue-on-error: true
        run: |
          echo "ğŸ§ª Running tests..."
          
          # testAll í•¨ìˆ˜ ì‹¤í–‰
          TEST_OUTPUT=$(clasp run testAll 2>&1)
          TEST_EXIT_CODE=$?
          
          echo "$TEST_OUTPUT"
          
          if [ $TEST_EXIT_CODE -eq 0 ]; then
            echo "âœ… All tests passed!"
            echo "test_result=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Tests failed!"
            echo "test_result=failure" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: Get execution logs
        if: always()
        run: |
          echo "ğŸ“‹ Fetching execution logs..."
          clasp logs --json --simplified || echo "âš ï¸  Could not fetch logs"
      
      - name: Test Results Summary
        if: always()
        run: |
          if [ "${{ steps.test.outputs.test_result }}" = "success" ]; then
            echo "### âœ… Deployment Successful" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All tests passed! Your code is now live." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.test.outputs.test_result }}" = "failure" ]; then
            echo "### âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Tests failed. Please check the logs above." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Code was pushed but tests did not pass.**" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸  Test Status Unknown" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Could not determine test results." >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Deployment or tests failed! Check the logs for details."
      
      - name: Deployment complete
        if: success()
        run: |
          echo "ğŸ‰ Deployment and tests completed successfully!"
          echo "Your Apps Script project is updated and tested."