name: Deploy and Test Apps Script

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  deploy-and-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: |
          npm install -g @google/clasp@latest
          npm install
      
      - name: Setup credentials
        run: |
          echo '${{ secrets.CLASPRC_JSON }}' > ~/.clasprc.json.raw
          
          node << 'SCRIPT'
          const fs = require('fs');
          const data = JSON.parse(fs.readFileSync(process.env.HOME + '/.clasprc.json.raw', 'utf8'));
          
          let result;
          if (data.tokens && data.tokens.default) {
            console.log('ğŸ”„ Converting credentials format...');
            const token = data.tokens.default;
            result = {
              token: {
                access_token: token.access_token,
                refresh_token: token.refresh_token,
                scope: "https://www.googleapis.com/auth/script.projects https://www.googleapis.com/auth/script.webapp.deploy https://www.googleapis.com/auth/logging.read https://www.googleapis.com/auth/service.management https://www.googleapis.com/auth/drive.metadata.readonly https://www.googleapis.com/auth/drive.file",
                token_type: token.token_type || "Bearer",
                expiry_date: token.expiry_date
              },
              oauth2ClientSettings: {
                clientId: token.client_id,
                clientSecret: token.client_secret,
                redirectUri: "http://localhost"
              },
              isLocalCreds: false
            };
            console.log('âœ… Credentials converted');
          } else {
            result = data;
          }
          
          fs.writeFileSync(process.env.HOME + '/.clasprc.json', JSON.stringify(result, null, 2));
          SCRIPT
      
      - name: Validate code syntax
        run: |
          echo "ğŸ” Validating JavaScript syntax..."
          for file in src/*.gs; do
            if [ -f "$file" ]; then
              echo "Checking $(basename $file)..."
              node --check "$file"
            fi
          done
          echo "âœ… All files have valid syntax"
      
      - name: Deploy to Apps Script
        run: |
          echo "ğŸ“¤ Deploying to Apps Script..."
          clasp push --force
          echo "âœ… Code deployed successfully"
      
      - name: Enable Apps Script API
        run: |
          echo "ğŸ”§ Ensuring Apps Script API is enabled..."
          clasp apis enable script 2>/dev/null || echo "API already enabled or using default"
      
      - name: Run automated tests
        id: test
        run: |
          echo "ğŸ§ª Running automated tests via Apps Script API..."
          
          # Node.js ìŠ¤í¬ë¦½íŠ¸ë¡œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
          node << 'TESTSCRIPT'
          const { google } = require('googleapis');
          const fs = require('fs');
          
          async function runTests() {
            try {
              // ì¸ì¦ ì •ë³´ ë¡œë“œ
              const credentials = JSON.parse(fs.readFileSync(process.env.HOME + '/.clasprc.json', 'utf8'));
              const claspConfig = JSON.parse(fs.readFileSync('.clasp.json', 'utf8'));
              
              // OAuth2 í´ë¼ì´ì–¸íŠ¸ ìƒì„±
              const oauth2Client = new google.auth.OAuth2(
                credentials.oauth2ClientSettings.clientId,
                credentials.oauth2ClientSettings.clientSecret,
                credentials.oauth2ClientSettings.redirectUri
              );
              
              oauth2Client.setCredentials(credentials.token);
              
              // Apps Script API í´ë¼ì´ì–¸íŠ¸
              const script = google.script({ version: 'v1', auth: oauth2Client });
              
              console.log('ğŸ“‹ Script ID:', claspConfig.scriptId);
              console.log('ğŸš€ Executing testAll() function...');
              
              // testAll í•¨ìˆ˜ ì‹¤í–‰
              const response = await script.scripts.run({
                scriptId: claspConfig.scriptId,
                requestBody: {
                  function: 'testAll',
                  devMode: true
                }
              });
              
              console.log('\n=== Test Execution Results ===');
              
              if (response.data.error) {
                console.error('âŒ Test execution failed!');
                console.error('Error:', response.data.error.details);
                process.exit(1);
              }
              
              if (response.data.response) {
                const result = response.data.response.result;
                console.log('Response:', JSON.stringify(result, null, 2));
                
                // ê²°ê³¼ ë¶„ì„
                if (typeof result === 'object' && result.failed > 0) {
                  console.error(`âŒ Tests failed: ${result.failed} out of ${result.total}`);
                  if (result.errors) {
                    result.errors.forEach(err => {
                      console.error(`  - ${err.test}: ${err.error}`);
                    });
                  }
                  process.exit(1);
                } else {
                  console.log('âœ… All tests passed!');
                  if (result.total) {
                    console.log(`   Total: ${result.total}`);
                    console.log(`   Passed: ${result.passed}`);
                  }
                }
              } else {
                console.log('âœ… Test function executed successfully');
              }
              
            } catch (error) {
              console.error('âŒ Error running tests:', error.message);
              
              if (error.message.includes('User has not enabled the Apps Script API')) {
                console.error('\nğŸ”§ Please enable the Apps Script API:');
                console.error('   1. Visit: https://script.google.com/home/usersettings');
                console.error('   2. Enable "Google Apps Script API"');
              }
              
              if (error.code === 404) {
                console.error('\nâš ï¸  Script not found. Please verify:');
                console.error('   1. Script ID is correct in .clasp.json');
                console.error('   2. You have access to the script');
              }
              
              process.exit(1);
            }
          }
          
          runTests();
          TESTSCRIPT
      
      - name: Fetch execution logs
        if: always()
        run: |
          echo ""
          echo "ğŸ“‹ Fetching execution logs..."
          clasp logs --simplified || echo "âš ï¸  Could not fetch detailed logs"
      
      - name: Generate test report
        if: always()
        run: |
          if [ "${{ steps.test.outcome }}" = "success" ]; then
            echo "### âœ… Deployment & Tests Successful" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ‰ All tests passed! Your code is deployed and working." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Tests Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸  Code was deployed but tests did not pass." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Action Required:**" >> $GITHUB_STEP_SUMMARY
            echo "- Check the test logs above" >> $GITHUB_STEP_SUMMARY
            echo "- Run \`clasp open\` to debug in Apps Script Editor" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Deployment or tests failed! Check logs above for details."