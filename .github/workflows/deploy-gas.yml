name: Deploy and Test Apps Script

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  deploy-and-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
      
      - name: Install clasp
        run: npm install -g @google/clasp@latest
      
      - name: Setup credentials
        run: |
          echo '${{ secrets.CLASPRC_JSON }}' > ~/.clasprc.json.raw
          
          node << 'SCRIPT'
          const fs = require('fs');
          const data = JSON.parse(fs.readFileSync(process.env.HOME + '/.clasprc.json.raw', 'utf8'));
          
          let result;
          if (data.tokens && data.tokens.default) {
            console.log('ðŸ”„ Converting credentials format...');
            const token = data.tokens.default;
            result = {
              token: {
                access_token: token.access_token,
                refresh_token: token.refresh_token,
                scope: "https://www.googleapis.com/auth/script.projects https://www.googleapis.com/auth/script.webapp.deploy https://www.googleapis.com/auth/logging.read",
                token_type: token.token_type || "Bearer",
                expiry_date: token.expiry_date
              },
              oauth2ClientSettings: {
                clientId: token.client_id,
                clientSecret: token.client_secret,
                redirectUri: "http://localhost"
              },
              isLocalCreds: false
            };
            console.log('âœ… Credentials ready');
          } else {
            result = data;
          }
          
          fs.writeFileSync(process.env.HOME + '/.clasprc.json', JSON.stringify(result, null, 2));
          SCRIPT
      
      - name: Validate code syntax
        run: |
          echo "ðŸ” Validating JavaScript syntax..."
          for file in src/*.gs; do
            if [ -f "$file" ]; then
              echo "  Checking $(basename $file)..."
              node --check "$file"
            fi
          done
          echo "âœ… All files have valid syntax"
      
      - name: Verify project structure
        run: |
          echo "ðŸ“ Project structure:"
          ls -la src/
          echo ""
          echo "ðŸ“‹ .clasp.json:"
          cat .clasp.json
      
      - name: Deploy to Apps Script
        run: |
          echo "ðŸ“¤ Deploying to Apps Script..."
          clasp push --force
          echo "âœ… Code deployed successfully"
      
      - name: Create new deployment
        id: deploy
        run: |
          echo "ðŸš€ Creating new web app deployment..."
          DEPLOY_OUTPUT=$(clasp deploy --description "Auto-deploy $(date +'%Y-%m-%d %H:%M:%S')" 2>&1)
          echo "$DEPLOY_OUTPUT"
          
          # Deployment ID ì¶”ì¶œ
          DEPLOY_ID=$(echo "$DEPLOY_OUTPUT" | grep -oP '(?<=Created version )\d+|(?<=- )[A-Za-z0-9_-]+' | head -1)
          
          if [ -n "$DEPLOY_ID" ]; then
            echo "deployment_id=$DEPLOY_ID" >> $GITHUB_OUTPUT
            echo "âœ… Deployment ID: $DEPLOY_ID"
          else
            echo "âš ï¸  Could not extract deployment ID, will use existing deployment"
          fi
      
      - name: Get Web App URL
        id: webapp
        run: |
          echo "ðŸ”— Getting web app URL..."
          
          # Web App URLì´ Secretì— ìžˆìœ¼ë©´ ì‚¬ìš©
          if [ -n "${{ secrets.WEBAPP_URL }}" ]; then
            WEBAPP_URL="${{ secrets.WEBAPP_URL }}"
            echo "âœ… Using saved Web App URL"
          else
            # deployments ëª©ë¡ì—ì„œ URL ì¶”ì¶œ ì‹œë„
            DEPLOYMENTS=$(clasp deployments 2>&1)
            echo "$DEPLOYMENTS"
            
            # URL íŒ¨í„´ ì°¾ê¸°
            WEBAPP_URL=$(echo "$DEPLOYMENTS" | grep -oP 'https://script\.google\.com/macros/s/[A-Za-z0-9_-]+/exec' | head -1)
            
            if [ -z "$WEBAPP_URL" ]; then
              echo "âš ï¸  Web App URL not found!"
              echo "Please deploy manually and add WEBAPP_URL to secrets:"
              echo "1. Run: clasp open"
              echo "2. Deploy â†’ New deployment â†’ Web app"
              echo "3. Copy URL and add to GitHub Secrets as WEBAPP_URL"
              exit 1
            fi
          fi
          
          echo "webapp_url=$WEBAPP_URL" >> $GITHUB_OUTPUT
          echo "ðŸŒ Web App URL: $WEBAPP_URL"
      
      - name: Run automated tests
        id: test
        run: |
          echo "ðŸ§ª Running automated tests..."
          WEBAPP_URL="${{ steps.webapp.outputs.webapp_url }}"
          TEST_URL="${WEBAPP_URL}?test=1"
          
          echo "ðŸ“¡ Calling: $TEST_URL"
          echo ""
          
          # HTTP ìš”ì²­ (ìµœëŒ€ 30ì´ˆ ëŒ€ê¸°)
          RESPONSE=$(curl -L -s -m 30 "$TEST_URL")
          echo "Response:"
          echo "$RESPONSE" | jq '.' 2>/dev/null || echo "$RESPONSE"
          echo ""
          
          # JSON íŒŒì‹± ë° ê²°ê³¼ í™•ì¸
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success' 2>/dev/null)
          
          if [ "$SUCCESS" = "true" ]; then
            PASSED=$(echo "$RESPONSE" | jq -r '.results.passed' 2>/dev/null)
            TOTAL=$(echo "$RESPONSE" | jq -r '.results.total' 2>/dev/null)
            echo "âœ… All tests passed! ($PASSED/$TOTAL)"
            echo "test_result=success" >> $GITHUB_OUTPUT
          else
            ERROR=$(echo "$RESPONSE" | jq -r '.error' 2>/dev/null)
            echo "âŒ Tests failed!"
            echo "Error: $ERROR"
            echo "test_result=failure" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: Test summary
        if: always()
        run: |
          if [ "${{ steps.test.outputs.test_result }}" = "success" ]; then
            echo "### âœ… Deployment & Tests Successful" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŽ‰ All tests passed! Your code is live." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Web App URL:** ${{ steps.webapp.outputs.webapp_url }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Tests Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸  Code was deployed but tests did not pass." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Troubleshooting:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Run \`clasp open\` to debug" >> $GITHUB_STEP_SUMMARY
            echo "2. Manually run \`testAll()\` in the editor" >> $GITHUB_STEP_SUMMARY
            echo "3. Check execution logs" >> $GITHUB_STEP_SUMMARY
          fi
